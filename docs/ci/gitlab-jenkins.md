# SRE

[SRE内部培训分享-文档](http://c.100credit.cn/pages/viewpage.action?pageId=93312883)

[sre平台架构升级优化](http://c.100credit.cn/pages/viewpage.action?pageId=60420542)

<!-- ## sre平台架构升级优化

- **确定重构的目的和必要性** - 随着产品的持续迭代，平台的使用也越来越深入，对整体服务的可靠性，可用性提出了新的挑战

- **定义“重构完成”的界限** - 微服务化，容器化平台

- **渐进式重构** - 以迭代的方式，按优化级逐步重构。例如服务的运维，日志服务，持续集成、持续发布、服务全生命周期管理

- **确定当前的架构状态** - 确定目前架构存在的不足

- **远离虚的东西** - 新引入的技术点都有成熟可借鉴的方案 -->

### 架构图

  ![微服务架构](https://cdn.jsdelivr.net/gh/Eadela/pic-go/img/202305171119297.png)

各个应用层在微服务架构下的职责：

- **运行环境层**：提供基础设施服务，包括服务器，IT安全配置以及容器云平台。未来所有的服务都会运行在容器云平台上
- **数据存储层**：提供数据存储能力，对于不同的数据类型，提供了不同的存储方式。Mysql用于应用数据的存储，redis用于缓存数据的存储，ES集群用于快速检索
- **基础服务层**：提供基础公共服务能力，除了为sre平台发布平台本身提供基础服务 日志服务(ELK)提供日志采集，存储，分析和展示服务； 消息服务提供组件间的通信能力； 任务调度和后台作业(Quaz)提供了长耗时任务队列的调度和处理服务； 身份认证服务面向开放提供了统一的身份认证能力。
- **应用服务层**：研发协同业务服务，主要包含基础服务，持续集成服务、质量服务和持续交付服务。
- **API接口层**：API网关为服务消费端提供了统一的服务入口。除了网关，还必须实现服务治理：服务的注册、发现、负载、容错、降级、日志。
- **展示层**：展示层是通过API网关来使用应用服务。

### DevOps架构CICD程序设计图: 

![CICD程序架构图](https://cdn.jsdelivr.net/gh/Eadela/pic-go/img/202305171119322.png)
<!-- 
### 微服化架构

#### 1. 微服务架构之服务拆分

将原来的单体应用系统分解为一系列的服务其实是有难度的，可以遵循以下两种分解策略:

- 根据业务能力分解
- 根据子域分解

##### 1)通信方式

使用微服务架构的应用程序是分布式系统，进程间通信是重要组成部分，有以下几种通信模式:

- 通信风格: 使用哪一种的进程间通信机制;
- 服务发现: 客户端如何获得具体实例的真实IP地址;
- 可靠性: 在服务不可用的情况下，如何确保服务之间的可靠通信;
- 事务性消息: 如何将消息发送、事件发布、更新业务数据的数据库事务集成;
- 外部API: 应用客户端如何与服务通信.

##### 2) 数据一致性模式

在微服务架构下每个服务都有自己独立的数据库，原先在单应用架构下的2PC的事务机制在微服务架构中就不再适用，需要类似于分布式事务的中间件来保证数据的一致性。

##### 3) 可观测性

- 健康检查API：每个微服务应用需要一个可以返回健康状体的API;
- 日志聚合: 把服务器节点的所有日志都写入一个集中式的日志服务器，可在这个服务器上进行日志搜索，并根据日志情况出发告警，典型的方案是Log路径+容器+ES;
- 分布式链路跟踪:为每一个外部的请求分配一个唯一的ID，用于在各个服务之间的跟踪外部请求
- 应用指标: 维护使用的指标，如调用计数;
- 审计日志: 记录用户的行为;

##### 4) 部署相关模式

部署基于微服务的应用程序就要复杂得多，通常应有数十甚至上百个服务组成。 需要一个高度自动化部署的基础设施，如可以管理需求任务、代码变更， 服务器资源环境于一身的部署平台。

##### 5) 安全相关

在微服务架构中，用户身份、权限验证的工作通常由网关完成的，常见的解决方式是Outh2协议的访问令牌模式，由网关将访问令牌传递到服务，验证令牌并获取用户有关的信息。


**微内核架构**（Microkernel Architecture），也被称为**插件式架构**（plug-in architecture)

### 基本架构

微内核架构包含两类组件：

- 核心系统（Core System）
  - 功能：负责和业务无关的通用功能（模块加载、模块间通信等）
  - 特点：通常比较稳定，不会因为业务变动而修改
- 插件模块（Plug-in Modules）
  - 功能：负责实现具体业务逻辑
  - 特点：可以根据业务需求变更不断扩展



#### 核心系统设计关键点

1. 插件管理
   - 核心功能：插件注册表 
   - 包含插件信息、加载机制等功能 
2. 插件连接
   - 核心功能：插件与核心系统的连接管理
   - 常见机制如：OSGi（开放服务网关倡议）、消息模式、（Spring)依赖注入、分布式协议（HTTP、RPC）等
3. 插件通信
   - 核心功能：插件间通信

#### 微内核架构实现

JDK 已经为我们提供了一种微内核架构的实现方式，就是JDK SPI。这种实现方式针对如何设计和实现 SPI 提出了一些开发和配置上的规范，很多框架都是使用这种规范，只不过在这基础上进行了增强和优化。



#### 同城双活架构

同城双活是在同城或相近区域内建立两个机房。同城双机房距离比较近，通信线路质量较好，比较容易实现数据的同步复制 ，保证高度的数据完整性和数据零丢失。

同城两个机房各承担一部分流量，一般入口流量完全随机，内部RPC调用尽量通过就近路由闭环在同机房，相当于两个机房镜像部署了两个独立集群，数据仍然是单点写到主机房数据库，然后实时同步到另外一个机房。

  -->